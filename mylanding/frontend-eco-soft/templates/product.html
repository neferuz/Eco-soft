<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>BIRRUTI </title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

	<style>
		body {
			background-color: #ffffff !important;
		}

		.product-main {
			display: flex;
			flex-wrap: wrap;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			gap: 50px;
			max-width: 1400px;
			margin: 48px auto 0;
			align-items: flex-start;
			background: #fff;
		}

		.product-gallery {
			flex: 1 1 400px;
			min-width: 440px;
			max-width: 600px;
		}

		.product-gallery-main {
			width: 100%;
			border-radius: 14px;
			margin-bottom: 18px;
		}

		.product-gallery-thumbs {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.product-gallery-thumbs img {
			width: 70px;
			height: 70px;
			object-fit: cover;
			border-radius: 8px;
			cursor: pointer;
			border: 1px solid #d8d8d8;
			transition: border 0.2s;
		}

		.product-gallery-thumbs img:hover {
			border: 1px solid #000000;
		}

		.product-info {
			flex: 1 1 400px;
			min-width: 440px;
		}

		.product-title {
			font-size: 25px;
			font-weight: 400;
			margin-bottom: 18px;
			color: #222;
		}

		.product-price {
			font-size: 20px;
			color: #222;
			font-weight: 400;
			margin-bottom: 18px;
		}

		.product-colors,
		.product-sizes {
			margin: 18px 0 8px;
			font-weight: 500;
		}

		.product-colors-list {
			display: flex;
			gap: 14px;
		}

		.product-color {
			display: flex;
			font-weight: 400;
			text-align: center;
			flex-direction: column;
			align-items: center;
		}

		.product-color img {
			width: 60px;
			height: 75px;
			border: 1px solid #c3c3c3;
			background: #fff;
		}

		.product-color span {
			font-size: 12px;
			margin-top: 4px;
			color: #444;
		}

		.product-sizes-list {
			display: flex;
			gap: 18px;
			margin-top: 12px;
		}

		.product-size {
			border: 2px solid #eee;
			border-radius: 6px;
			padding: 18px 32px;
			font-size: 1.25rem;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			cursor: pointer;
			background: #fff;
			transition: border 0.2s, color 0.2s;
			color: #222;
			font-weight: 500;
			box-sizing: border-box;
			text-align: center;
			min-width: 80px;
		}

		.product-size.active {
			border: 2px solid #111;
			color: #111;
			background: #fafafa;
		}

		.size-label {
			font-size: 17px;
			margin-top: 10px;
			font-weight: 400;
			margin-bottom: 6px;
			font-family: 'Helvetica Neue', Arial, sans-serif;
		}

		.product-description {
			margin: 28px 0 18px;
			line-height: 1.7;
			color: #222;
			font-weight: 400 !important;
			font-size: 15px;
		}

		.product-links {
			margin: 24px 0 8px;
			font-weight: 500;
		}

		.product-links-list {
			display: flex;
			gap: 18px;
			flex-wrap: wrap;
		}

		.product-link-btn {
			padding: 12px 28px;
			background: #006838;
			color: #fff;
			border-radius: 8px;
			text-decoration: none;
			font-weight: 600;
			font-size: 1rem;
			transition: background 0.2s;
		}

		.product-link-btn:hover {
			background: #004d2c;
		}

		@media (max-width: 900px) {
			.product-main {
				flex-direction: column;
				padding: 24px 8px;
				gap: 32px;
			}

			.product-gallery,
			.product-info {
				max-width: 100%;
			}
		}

		.nav-top__btn {
			text-decoration: none;
		}

		:root {
			--gap: 32px;
			--accent: #000;
			--hover: #1c1c1c;
			--brand: #006838;
			--f: 'Helvetica Neue', Arial, sans-serif;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			font-family: var(--f);
		}

		body {
			color: #000;
			background: #fffcf8;
			line-height: 1.35;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			background: #fffcf8;
			overflow-x: hidden;
		}

		/* ---------- header ---------- */
		.header {
			position: sticky;
			top: 0;
			z-index: 100;
			background: #ffffff;
			border-bottom: 1px solid #9e9e9e;
		}

		.header__row {
			max-width: 1440px;
			margin: 0 auto;
			padding: 0 var(--gap);
			display: flex;
			align-items: center;
			justify-content: space-between;
			height: 80px;
			position: relative;
		}

		.nav-top {
			display: flex;
			gap: var(--gap);
		}

		.nav-top__btn {
			background: none;
			border: none;
			cursor: pointer;
			font-size: 15px;
			letter-spacing: 1px;
			color: var(--accent);
			position: relative;
		}

		.nav-top__btn:hover::after,
		.nav-top__btn.is-active::after {
			content: '';
			position: absolute;
			left: 0;
			bottom: -6px;
			width: 100%;
			height: 2px;
			background: var(--accent);
		}

		.nav-top__btn:hover {
			color: var(--hover);
		}

		.brand {
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
			margin: 0;
			display: block;
			text-align: center;
			z-index: 2;
		}

		.brand span {
			display: block;
			font-size: 11px;
			letter-spacing: 4px;
			font-weight: 400;
		}

		.search {
			position: relative;
			width: 240px;
		}

		.search input {
			width: 100%;
			padding: 10px 36px 10px 40px;
			border: 1px solid #ddd;
			font-size: 14px;
		}

		.search i {
			position: absolute;
			left: 12px;
			top: 50%;
			transform: translateY(-50%);
			color: #666;
			font-size: 18px;
		}

		/* ---------- level‑2 ---------- */
		.subnav {
			border-top: 1px solid #848484;
		}

		.subnav__list {
			max-width: 1440px;
			margin: 0 auto;
			padding: 10px var(--gap);
			display: flex;
			text-decoration: none;
			gap: 32px;
			list-style: none;
		}

		.subnav__link {
			text-decoration: none;
			color: #0e0e0e;
			text-decoration: none;
			font-size: 15px;
		}

		.subnav__link:hover,
		.subnav__link.is-active {
			color: var(--accent);
		}

		/* ---------- mega ---------- */
		.mega {
			display: none;
			position: absolute;
			text-decoration: none;
			left: 0;
			right: 0;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			top: 100%;
			background: #ffffff;
			line-height: 1.35;
			border-bottom: 1px solid #828282;
			box-shadow: 0 6px 12px rgba(0, 0, 0, .05);
		}

		.mega.show {
			display: block;
		}

		.mega__wrap {
			max-width: 1440px;
			margin: 0 auto;
			padding: 32px var(--gap);
			display: flex;
			gap: 64px;
			position: relative;
		}

		.mega__col {
			flex: 1;
			min-width: 160px;
		}

		.mega__col h4 {
			margin-bottom: 12px;
			font-size: 18px;
			font-weight: 600;
		}

		.mega__col ul {
			list-style: none;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.mega__col a {
			text-decoration: none;
			color: var(--accent);
			font-size: 15px;
			position: relative;
		}

		.mega__col a:hover {
			color: var(--hover);
		}

		.has-child::after {
			content: '\f105';
			font-weight: 400;
			position: absolute;
			right: -14px;
			top: 0;
			font-size: 12px;
		}

		/* level‑4 */
		.mega-lvl2 {
			position: absolute;
			top: 0;
			left: 100%;
			width: 260px;
			height: 100%;
			background: #fff;
			border-left: 1px solid #848484;
			padding: 32px var(--gap);
			display: none;
			flex-direction: column;
			gap: 12px;
		}

		.mega-lvl2 h5 {
			font-size: 17px;
			font-weight: 600;
			margin-bottom: 8px;
		}

		.mega-lvl2 a {
			text-decoration: none;
			color: var(--accent);
			font-size: 15px;
		}

		.mega-lvl2 a:hover {
			color: var(--hover);
		}

		/* ---------- image block ---------- */
		.mega__img {
			flex: 0 0 260px;
			display: flex;
			flex-direction: column;
			gap: 18px;
			align-items: flex-start;
		}

		.mega__img img {
			width: 100%;
			object-fit: cover;
		}

		.mega__shop {
			text-decoration: none;
			font-size: 16px;
			color: var(--accent);
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.mega__shop i {
			transform: rotate(-45deg);
		}

		/* ---------- burger ---------- */
		.burger {
			display: none;
			background: none;
			border: none;
			font-size: 22px;
			cursor: pointer;
			color: var(--accent);
		}

		@media (max-width:767px) {

			.nav-top,
			.search,
			.subnav,
			.mega {
				display: none !important;
			}

			.burger {
				display: block;
			}

			.header__row {
				height: 60px;
			}
		}

		/* ---------- mobile menu ---------- */
		.m-overlay {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, .4);
			opacity: 0;
			visibility: hidden;
			transition: .3s;
			z-index: 140;
		}

		.m-overlay.is-open {
			opacity: 1;
			visibility: visible;
		}

		.m-menu {
			position: fixed;
			top: 0;
			left: -100%;
			width: 80%;
			max-width: 340px;
			height: 100%;
			background: #fff;
			box-shadow: 2px 0 12px rgba(0, 0, 0, .1);
			overflow-y: auto;
			transition: left .3s ease;
			z-index: 150;
			display: flex;
			flex-direction: column;
		}

		.m-menu.is-open {
			left: 0;
		}

		.m-menu__head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 18px 20px;
			border-bottom: 1px solid #eee;
		}

		.m-menu__head h3 {
			font-size: 18px;
			font-weight: 600;
		}

		.m-close {
			background: none;
			border: none;
			font-size: 22px;
			cursor: pointer;
			color: var(--accent);
		}

		.m-acc {
			border-bottom: 1px solid #eee;
		}

		.m-acc summary {
			list-style: none;
			padding: 16px 20px;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.m-acc summary::-webkit-details-marker {
			display: none;
		}

		.m-acc ul {
			padding: 0 26px 12px;
			list-style: none;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.m-acc a {
			text-decoration: none;
			color: var(--accent);
			font-size: 15px;
		}

		.m-acc a:hover {
			color: var(--hover);
		}

		.noscroll {
			overflow: hidden;
			height: 100%;
		}

		.product-accordion {
			margin-top: 32px;
		}

		.product-accordion details {
			border-bottom: 1px solid #e0e0e0;
			padding: 0;
		}

		.product-accordion summary {
			font-size: 17px;
			font-weight: 400;
			padding: 18px 0;
			cursor: pointer;
			outline: none;
			display: flex;
			justify-content: space-between;
			align-items: center;
			list-style: none;
		}

		.product-accordion summary::-webkit-details-marker {
			display: none;
		}

		.product-accordion summary:after {
			content: '+';
			font-size: 1.5rem;
			transition: transform 0.2s;
		}

		.product-accordion details[open] summary:after {
			content: '–';
			transform: rotate(180deg);
		}

		.product-accordion details>div {
			padding: 12px 0 18px 0;
			color: #444;
			font-size: 1rem;
		}

		.recommendations-section {
			max-width: 1200px;
			margin: 0 auto 48px auto;
			text-align: center;
		}

		.recommendations-row {
			display: flex;
			gap: 32px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 24px;
		}

		.recommendation-card {
			display: flex;
			flex-direction: column;
			align-items: center;
			width: 220px;
			background: #fff;
			border-radius: 16px;
			text-decoration: none;
			border: 1px solid #e0e0e0;
			color: #111;
			padding: 18px 10px 22px 10px;
			transition: box-shadow .2s, transform .2s;
			margin-bottom: 12px;
			position: relative;
			background: #fff;
		}

		.recommendation-card:hover {
			box-shadow: 0 6px 24px #0002;
			transform: translateY(-4px) scale(1.03);
		}

		.recommendation-card img {
			width: 100%;
			max-width: 180px;
			max-height: 180px;
			object-fit: contain;
			border-radius: 10px;
			margin-bottom: 10px;
			background: transparent;
		}

		.rec-badge {
			position: absolute;
			top: 18px;
			left: 18px;
			background: #2ecc40;
			color: #fff;
			font-size: 1rem;
			font-weight: 600;
			border-radius: 6px;
			padding: 2px 12px;
			z-index: 2;
		}

		.rec-title {
			margin-top: 0;
			font-weight: 400;
			font-size: 1.08rem;
			text-align: center;
			margin-bottom: 8px;
		}

		.rec-price {
			font-size: 1.15rem;
			font-weight: 600;
			color: #006838;
			margin-top: 8px;
		}

		.size-tabs {
			display: inline-block;
			margin-left: 12px;
			font-size: 17px;
			font-family: 'Helvetica Neue', Arial, sans-serif;
		}

		.size-tab {
			cursor: pointer;
			margin-right: 8px;
			color: #000;
			font-weight: 400;
			border-bottom: 2px solid transparent;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			font-size: 1.1rem;
			transition: color 0.2s, border 0.2s;
		}

		.size-tab.active {
			color: #414141;
			font-weight: 600;
			border-bottom: 2px solid #111;
		}

		.product-size {
			border: 2px solid #eee;
			border-radius: 4px;
			padding: 10px 22px;
			font-size: 1.1rem;
			font-weight: 400;
			cursor: pointer;
			margin-right: 10px;
			background: #fff;
			transition: border 0.2s;
		}

		.product-size.active {
			border: 1px solid #cacaca;
			background: #ffffff;
		}

		@media (max-width: 600px) {
			.product-sizes-list {
				flex-wrap: wrap;
				gap: 10px;
			}

			.product-size {
				padding: 10px 16px;
				font-size: 1rem;
				min-width: 60px;
			}
		}

		/* МОДАЛЬНОЕ ОКНО */
		.cart-modal {
			display: none;
			position: fixed;
			z-index: 3000;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
			width: 100vw;
			height: 100vh;
		}

		.cart-modal.show {
			display: block;
		}

		.cart-modal__overlay {
			position: fixed;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.35);
			z-index: 1;
		}

		.cart-modal__window {
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
			background: #fff;
			border-radius: 18px;
			box-shadow: 0 8px 40px #0003;
			max-width: 540px;
			width: 95vw;
			padding: 36px 32px 32px 32px;
			z-index: 2;
			display: flex;
			flex-direction: column;
			align-items: stretch;
		}

		.cart-modal__close {
			position: absolute;
			top: 24px;
			right: 28px;
			background: none;
			border: none;
			font-size: 2.2rem;
			color: #222;
			cursor: pointer;
			z-index: 3;
		}

		.cart-modal__titlebar {
			font-size: 2rem;
			font-weight: 400;
			margin-bottom: 32px;
			text-align: left;
			color: #222;
			letter-spacing: 0.5px;
		}

		.cart-modal__main {
			display: flex;
			gap: 32px;
			align-items: center;
			margin-bottom: 32px;
		}

		.cart-modal__img {
			width: 120px;
			height: 120px;
			object-fit: contain;
			border-radius: 12px;
			background: #fafafa;
			flex-shrink: 0;
			border: 1px solid #eee;
		}

		.cart-modal__info {
			flex: 1;
			text-align: left;
		}

		.cart-modal__product-title {
			font-size: 1.25rem;
			font-weight: 500;
			margin-bottom: 6px;
			color: #222;
		}

		.cart-modal__product-meta {
			font-size: 1.05rem;
			color: #444;
			margin-bottom: 6px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.cart-modal__color-dot {
			display: inline-block;
			width: 18px;
			height: 18px;
			border-radius: 50%;
			margin-right: 6px;
			border: 1px solid #ccc;
			vertical-align: middle;
		}

		.cart-modal__price {
			font-size: 1.15rem;
			color: #111;
			font-weight: 600;
			margin-top: 8px;
		}

		.cart-modal__marketplaces {
			display: flex;
			gap: 18px;
			margin-top: 32px;
			justify-content: stretch;
			flex-wrap: wrap;
		}

		.cart-modal__marketplace-btn {
			flex: 1 1 180px;
			background: #000;
			color: #fff;
			border-radius: 12px;
			padding: 20px 0;
			font-size: 1.15rem;
			font-weight: 500;
			text-align: center;
			text-decoration: none;
			margin-bottom: 0;
			transition: background 0.2s, box-shadow 0.2s;
			box-shadow: 0 2px 12px #0001;
			border: none;
			cursor: pointer;
		}

		.cart-modal__marketplace-btn:hover {
			background: #222;
		}

		@media (max-width: 600px) {
			.cart-modal__window {
				padding: 12px 4px 18px 4px;
				max-width: 99vw;
			}

			.cart-modal__main {
				flex-direction: column;
				gap: 16px;
				align-items: flex-start;
			}

			.cart-modal__img {
				width: 90px;
				height: 90px;
			}

			.cart-modal__marketplaces {
				gap: 10px;
				margin-top: 18px;
			}

			.cart-modal__marketplace-btn {
				font-size: 1rem;
				padding: 13px 0;
				border-radius: 8px;
			}

			.cart-modal__titlebar {
				font-size: 1.1rem;
				margin-bottom: 18px;
			}
		}

		.add-to-cart-btn {
			width: 100%;
			height: 70px;
			background: #000;
			color: #fff;
			border: none;
			padding: 20px 0;
			font-size: 20px;
			font-weight: 400;
			font-family: 'Helvetica Neue', Arial, sans-serif;
			margin: 24px 0 0 0;
			box-shadow: 0 4px 24px #0001;
			cursor: pointer;
			transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
			letter-spacing: 1px;
			text-align: center;
		}

		.add-to-cart-btn:hover,
		.add-to-cart-btn:focus {
			background: #222;
			box-shadow: 0 8px 32px #0002;
			transform: translateY(-2px) scale(1.01);
			color: #fff;
		}

		@media (max-width: 600px) {
			.add-to-cart-btn {
				font-size: 1.05rem;
				padding: 13px 0;
				border-radius: 10px;
			}
		}
	</style>
</head>

<body>
	<header class="header">
		<div class="header__row">
			<button class="burger" id="burger"><i class="fa-solid fa-bars"></i></button>
			<nav class="nav-top" id="navTop"></nav>
			<a href="#" class="brand" id="brandLogo"></a>
			<div class="search">
				<i class="fa-solid fa-magnifying-glass"></i>
				<input type="search" placeholder="Search">
			</div>
		</div>
		<nav class="subnav">
			<ul class="subnav__list" id="subnavList"></ul>
		</nav>
		<div class="mega" id="mega">
			<div class="mega__wrap" id="megaWrap"></div>
		</div>
	</header>
	<!-- mobile -->
	<div class="m-overlay" id="mOverlay"></div>
	<nav class="m-menu" id="mMenu">
		<div class="m-menu__head">
			<h3>Menu</h3>
			<button class="m-close" id="mClose"><i class="fa-solid fa-xmark"></i></button>
		</div>
		<div id="mContent"></div>
	</nav>
	<main>
		<div id="product-container"
			style="max-width:1100px;margin:40px auto 0;display:flex;gap:40px;flex-wrap:wrap;align-items:flex-start;">
		</div>
	</main>
	<!-- МОДАЛЬНОЕ ОКНО -->
	<div id="cartModal" class="cart-modal">
		<div class="cart-modal__overlay" id="cartModalOverlay"></div>
		<div class="cart-modal__window" id="cartModalWindow">
			<button class="cart-modal__close" id="cartModalClose">&times;</button>
			<div class="cart-modal__titlebar">Very good choice! The item has been added to the shopping cart.</div>
			<div class="cart-modal__main">
				<img id="modalProductImg" class="cart-modal__img" src="" alt="" />
				<div class="cart-modal__info">
					<div class="cart-modal__product-title" id="modalProductTitle"></div>
					<div class="cart-modal__product-meta" id="modalProductMeta"></div>
					<div class="cart-modal__price" id="modalProductPrice"></div>
				</div>
			</div>
			<div class="cart-modal__marketplaces" id="modalMarketplaces"></div>
		</div>
	</div>
	<script src="{% static 'js/product.js' %}"></script>
	<script>
		/* ---------- DATA ---------- */
		let menuData = {};
		let activeCategory = null; // глобально
		let selectedSize = null;
		let lastProduct = null;

		/* ---------- DOM ---------- */
		const subnav = document.getElementById('subnavList');
		const navTopBtns = document.querySelectorAll('.nav-top__btn');
		const mega = document.getElementById('mega');
		const megaWrap = document.getElementById('megaWrap');

		/* ---------- helpers ---------- */
		async function loadMenuData() {
			try {
				const response = await fetch('http://localhost:8001/api/shop-menu/');
				menuData = await response.json();
				console.log('Loaded menu data:', menuData); // Отладочная информация
				renderNavTop();
				if (isKidsPage()) {
					renderSub('kids');
				} else {
					const activeCat = getCategoryFromUrl() || Object.keys(menuData)[0];
					renderSub(activeCat);
				}
			} catch (error) {
				console.error('Error loading menu data:', error);
			}
		}

		// Загружаем данные при загрузке страницы
		loadMenuData();

		function renderSub(cat) {
			if (isKidsPage()) cat = 'kids';
			console.log('Rendering category:', cat, menuData[cat]); // Отладочная информация
			if (!menuData[cat]) {
				console.log('No data for category:', cat);
				return;
			}
			subnav.innerHTML = menuData[cat].list.map(txt =>
				`<li><a href="#" class="subnav__link" data-sub="${txt}">${txt}</a></li>`).join('');
		}

		function buildLvl2(label, children) {
			let lvl2 = document.getElementById('megaLvl2');
			if (!lvl2) {
				lvl2 = document.createElement('div');
				lvl2.id = 'megaLvl2';
				lvl2.className = 'mega-lvl2';
				megaWrap.appendChild(lvl2);
			}

			const activeCat = document.querySelector('.nav-top__btn.is-active').dataset.cat;
			const subcategory = menuData[activeCat].subcategories.find(sub => sub.name === label);
			const subsubcategories = subcategory ? subcategory.subsubcategories : [];

			lvl2.innerHTML = `
            <ul>${children.map(c => {
				const subsubcat = subsubcategories.find(ss => ss.name === c);
				if (subsubcat) {
					return `<li><a href="/category-products/?subsubcat_id=${subsubcat.id}&subsubcat_name=${encodeURIComponent(subsubcat.name)}">${subsubcat.name}</a></li>`;
				}
				return `<li>${c}</li>`;
			}).join('')}</ul>
        `;
			lvl2.style.display = 'flex';
		}

		function hideLvl2() {
			const lvl2 = document.getElementById('megaLvl2');
			if (lvl2) lvl2.style.display = 'none';
		}

		function renderMega(cat, key) {
			const obj = menuData[cat].mega ? menuData[cat].mega[key] : null;
			if (!obj) { mega.classList.remove('show'); return; }

			// Найди подкатегорию по key
			const subcategory = menuData[cat].subcategories.find(sub => sub.name === key);
			const subsubcategories = subcategory ? subcategory.subsubcategories : [];

			megaWrap.innerHTML = obj.cols.map(col => {
				const lis = col.items.map(i => {
					const subsubcat = subsubcategories.find(ss => ss.name === i);
					if (subsubcat) {
						let subsubsubHtml = '';
						if (subsubcat.subsubsubcategories && subsubcat.subsubsubcategories.length > 0) {
							subsubsubHtml = `<div style="margin-left:12px;margin-top:4px;">
                            ${subsubcat.subsubsubcategories.map(sss =>
								`<a href="/category-products/?subsubcat_id=${sss.id}&subsubcat_name=${encodeURIComponent(sss.name)}" style="display:block;font-size:14px;color:#000;margin-bottom:2px;">${sss.name}</a>`
							).join('')}
                        </div>`;
						}
						return `<li>
                        <a href="/category-products/?subsubcat_id=${subsubcat.id}&subsubcat_name=${encodeURIComponent(subsubcat.name)}">${subsubcat.name}</a>
                        ${subsubsubHtml}
                    </li>`;
					}
					return `<li>${i}</li>`;
				}).join('');
				return `<div class="mega__col"><ul>${lis}</ul></div>`;
			}).join('');

			/* image column */
			if (obj.image) {
				megaWrap.insertAdjacentHTML('beforeend', `
                <div class="mega__img">
                    <a href="${obj.image.link}"><img src="${obj.image.src}" alt="${obj.image.alt}"></a>
                    <a href="${obj.image.link}" class="mega__shop"><i class="fa-solid fa-arrow-up"></i>${obj.image.caption}</a>
                </div>
            `);
			}

			mega.classList.add('show');
		}

		/* ---------- level‑1 events ---------- */
		navTopBtns.forEach(btn => {
			btn.onclick = () => {
				document.querySelector('.nav-top__btn.is-active').classList.remove('is-active');
				btn.classList.add('is-active');
				renderSub(btn.dataset.cat);
				mega.classList.remove('show');
			};
		});

		/* ---------- level‑2 events ---------- */
		subnav.addEventListener('mouseover', e => {
			const l = e.target.closest('.subnav__link');
			if (l) {
				const activeCat = document.querySelector('.nav-top__btn.is-active').dataset.cat;
				renderMega(activeCat, l.dataset.sub);
			}
		});

		/* ---------- level‑3 → level‑4 events ---------- */
		megaWrap.addEventListener('mouseover', e => {
			const link = e.target.closest('.has-child');
			if (link) buildLvl2(link.textContent.trim(), JSON.parse(link.dataset.deep));
		});

		/* hide lvl‑4 when pointer leaves both mega and lvl‑4 */
		mega.addEventListener('mouseleave', () => {
			mega.classList.remove('show');
			hideLvl2();
		});

		/* ---------- MOBILE ---------- */
		const burger = document.getElementById('burger');
		const mMenu = document.getElementById('mMenu');
		const mOverlay = document.getElementById('mOverlay');
		const mClose = document.getElementById('mClose');
		const mContent = document.getElementById('mContent');
		let startX = null;

		function buildMobile() {
			mContent.innerHTML = Object.entries(menuData).map(([cat, val]) => {
				const subItems = val.list.map(sub => {
					const v = (val.mega && val.mega[sub]) ? val.mega[sub] : null;
					if (v) {
						/* вложенный аккордеон */
						const deepCols = v.cols.map(col => `
                        <li><strong>${col.title}</strong>
                            <ul style="margin-top:6px">${col.items.map(i => {
							if (typeof i === 'string') return `<li><a href="#">${i}</a></li>`;
							return `<li><a href="#">${i.label}</a></li>`;
						}).join('')}</ul>
                        </li>`).join('');
						return `<li>
                        <details class="m-acc">
                            <summary>${sub}</summary>
                            <ul>${deepCols}</ul>
                        </details>
                    </li>`;
					}
					return `<li><a href="#">${sub}</a></li>`;
				}).join('');

				return `<details class="m-acc">
                <summary>${cat.toUpperCase()}</summary>
                <ul>${subItems}</ul>
            </details>`;
			}).join('');
		}
		buildMobile();

		const openBurger = () => {
			mMenu.classList.add('is-open');
			mOverlay.classList.add('is-open');
			document.body.classList.add('noscroll');
		};
		const closeBurger = () => {
			mMenu.classList.remove('is-open');
			mOverlay.classList.remove('is-open');
			document.body.classList.remove('noscroll');
		};

		burger.onclick = openBurger;
		mClose.onclick = closeBurger;
		mOverlay.onclick = closeBurger;

		mMenu.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
		mMenu.addEventListener('touchmove', e => {
			if (startX !== null) {
				const diff = e.touches[0].clientX - startX;
				if (diff > 60) { closeBurger(); startX = null; }
			}
		});
		mMenu.addEventListener('touchend', () => startX = null);

		function getCategoryFromUrl() {
			const params = new URLSearchParams(window.location.search);
			return params.get('category');
		}

		function renderNavTop() {
			const navTop = document.getElementById('navTop');
			navTop.innerHTML = '';
			if (isKidsPage()) {
				// HOME
				const home = document.createElement('a');
				home.className = 'nav-top__btn';
				home.textContent = 'HOME';
				home.href = '/';
				navTop.appendChild(home);
				// Только KIDS
				const a = document.createElement('a');
				a.className = 'nav-top__btn is-active';
				a.dataset.cat = 'kids';
				a.textContent = menuData['kids']?.name ? menuData['kids'].name.toUpperCase() : 'KIDS';
				a.href = '/kids/';
				navTop.appendChild(a);
			} else {
				// Обычное меню (MEN, WOMEN, ...)
				const cats = Object.keys(menuData);
				cats.forEach((cat) => {
					const isActive = activeCategory
						? cat.toLowerCase() === activeCategory.toLowerCase()
						: cat.toLowerCase() === 'men';
					const a = document.createElement('a');
					a.className = 'nav-top__btn' + (isActive ? ' is-active' : '');
					a.dataset.cat = cat;
					a.textContent = menuData[cat].name ? menuData[cat].name.toUpperCase() : cat.toUpperCase();
					if (cat.toLowerCase() === 'men') {
						a.href = '/shop.html?category=men';
					} else if (cat.toLowerCase() === 'women') {
						a.href = '/women';
					} else if (cat.toLowerCase() === 'home') {
						a.href = '/';
					} else {
						a.href = `?category=${cat}`;
					}
					navTop.appendChild(a);
				});
			}
		}

		function getProductIdFromUrl() {
			const params = new URLSearchParams(window.location.search);
			return params.get('id');
		}

		function renderProduct(product, color = null) {
			color = color || (product.colors && product.colors[0]) || {};
			lastProduct = product;
			// Галерея фото для выбранного цвета
			const imagesHtml = (color.images && color.images.length ? color.images : product.images || []).map(img =>
				`<img src="${img}" alt="${product.title}" class="product-thumb" onclick="document.getElementById('main-product-img').src='${img}'">`
			).join('');

			// Цвета
			const colorsHtml = product.colors && product.colors.length
				? `<div class="product-colors">Colors:</div>
               <div class="product-colors-list">${product.colors.map((c, idx) =>
					`<div class="product-color${c.name === color.name ? ' active' : ''}" data-idx="${idx}">
                            <img src="${c.color_image}" alt="${c.name}">
                            <span>${c.name}</span>
                        </div>`
				).join('')
				}</div>`
				: '';

			// --- Размеры с табами ---
			let sizeSystems = ['EU', 'UK', 'US'];
			let availableSystems = sizeSystems.filter(sys => product.sizes && product.sizes[sys] && product.sizes[sys].length);
			let currentType = availableSystems[0] || 'EU';
			let currentSize = (product.sizes && product.sizes[currentType] && product.sizes[currentType][0]) || '';
			selectedSize = currentSize;

			function renderSizes() {
				// Табы
				let tabsHtml = sizeSystems.map(sys =>
					`<span class="size-tab${sys === currentType ? ' active' : ''}" data-type="${sys}">${sys}</span>`
				).join('');
				// Список размеров
				let sizes = (product.sizes && product.sizes[currentType]) || [];
				let sizesHtml = sizes.map(size =>
					`<span class="product-size${size === currentSize ? ' active' : ''}">${size}</span>`
				).join('');
				// Итоговый HTML
				return `
                <div class="size-label">
                    Size: <span style=" color: #5e5e5e; font-weight:400;">${currentSize}</span>
                    <span class="size-tabs">${tabsHtml}</span>
                </div>
                <div class="product-sizes-list">${sizesHtml}</div>
            `;
			}

			let sizesBlockHtml = renderSizes();

			// --- АККОРДЕОНЫ ---
			let accordionHtml = '';
			if (product.accordion_blocks && product.accordion_blocks.length) {
				accordionHtml = `
            <div class="product-accordion">
                ${product.accordion_blocks.map(block => `
                    <details>
                        <summary>${block.title || ''}</summary>
                        <div>
                            ${block.text ? `<div>${block.text}</div>` : ''}
                            ${block.image ? `<img src="${block.image}" alt="${block.title || ''}" style=" width: 150px; margin-top:10px;">` : ''}
                        </div>
                    </details>
                `).join('')}
            </div>
            `;
			}

			// Рекомендации
			let recommendationsHtml = '';
			if (product.recommendations && product.recommendations.length) {
				recommendationsHtml = `
                <div class="recommendations-section">
                    <h2 style="margin: 48px 0 0 0; font-size:20px; font-weight:400; letter-spacing:1px;">
                        MORE RECOMMENDATIONS FROM THIS CATEGORY
                    </h2>
                    <div class="recommendations-row">
                        ${product.recommendations.map(rec => `
                            <a href="product.html?id=${rec.id}" class="recommendation-card">
                                ${rec.badge ? `<div class="rec-badge">${rec.badge}</div>` : ''}
                                ${rec.main_image
						? `<img src="${rec.main_image}" alt="${rec.title}">`
						: `<div style="width:100%;height:180px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;border-radius:10px;color:#aaa;">No image</div>`
					}
                                <div class="rec-title">${rec.title}</div>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
			}

			document.getElementById('product-container').innerHTML = `
            <div class="product-main">
                <div class="product-gallery">
                    <img id="main-product-img" src="${(color.images && color.images[0]) || (product.images && product.images[0]) || ''}" alt="${product.title}" class="product-gallery-main">
                    <div class="product-gallery-thumbs">${imagesHtml}</div>
                </div>
                <div class="product-info">
                    <div class="product-title">${product.title || ''}</div>
                    <div class="product-price">${color.price || ''}</div>
                    ${colorsHtml}
                    ${sizesBlockHtml}
                    <button class="add-to-cart-btn" id="addToCartBtn">Add to cart</button>
                    <div class="product-description">${product.description || ''}</div>
                    ${accordionHtml}
                </div>
            </div>
        ` + recommendationsHtml;

			// При клике на цвет — меняем галерею и всё остальное
			document.querySelectorAll('.product-color').forEach((el, idx) => {
				el.onclick = () => {
					renderProduct(product, product.colors[idx]);
				};
			});

			// --- JS для интерактива табов и размеров ---
			function activateSizesEvents() {
				// Табы
				document.querySelectorAll('.size-tab').forEach(tab => {
					tab.onclick = () => {
						currentType = tab.dataset.type;
						currentSize = (product.sizes && product.sizes[currentType] && product.sizes[currentType][0]) || '';
						selectedSize = currentSize;
						document.querySelector('.product-info').innerHTML =
							`<div class="product-title">${product.title || ''}</div>
                        <div class="product-price">${color.price || ''}</div>
                        ${colorsHtml}
                        ${renderSizes()}
                        <div class="product-description">${product.description || ''}</div>
                        <button class="add-to-cart-btn" id="addToCartBtn">Add to cart</button>`;
						activateSizesEvents();
						document.getElementById('addToCartBtn').onclick = function () {
							openCartModal(product, color, selectedSize);
						};
					};
				});
				// Размеры
				document.querySelectorAll('.product-size').forEach(el => {
					el.onclick = () => {
						currentSize = el.textContent;
						selectedSize = currentSize;
						document.querySelector('.product-info').innerHTML =
							`<div class="product-title">${product.title || ''}</div>
                        <div class="product-price">${color.price || ''}</div>
                        ${colorsHtml}
                        ${renderSizes()}
                        <div class="product-description">${product.description || ''}</div>
                        <button class="add-to-cart-btn" id="addToCartBtn">Add to cart</button>`;
						activateSizesEvents();
						document.getElementById('addToCartBtn').onclick = function () {
							openCartModal(product, color, selectedSize);
						};
					};
				});
			}
			activateSizesEvents();

			// --- Add to cart modal ---
			document.getElementById('addToCartBtn').onclick = function () {
				openCartModal(product, color, selectedSize);
			};
		}

		function openCartModal(product, color, size) {
			document.getElementById('modalProductImg').src = (color.images && color.images[0]) || (product.images && product.images[0]) || '';
			document.getElementById('modalProductTitle').textContent = product.title || '';
			// Цвет, размер, количество
			let meta = '';
			if (color.name) {
				meta += `<span class="cart-modal__color-dot" style="background:${color.hex || '#222'}"></span> ${color.name}`;
			}
			if (size) {
				meta += ` / <span>${size}</span>`;
			}
			document.getElementById('modalProductMeta').innerHTML = meta;
			document.getElementById('modalProductPrice').textContent = color.price ? `$${color.price}` : '';
			// Маркетплейсы
			const mpDiv = document.getElementById('modalMarketplaces');
			if (product.marketplace_links && product.marketplace_links.length) {
				mpDiv.innerHTML = product.marketplace_links.map(link =>
					`<a href="${link.url}" target="_blank" class="cart-modal__marketplace-btn">${link.name}</a>`
				).join('');
			} else {
				mpDiv.innerHTML = '<div style="color:#000;">No marketplaces</div>';
			}
			document.getElementById('cartModal').classList.add('show');
		}

		// Закрытие модалки
		function closeCartModal() {
			document.getElementById('cartModal').classList.remove('show');
		}
		document.getElementById('cartModalClose').onclick = closeCartModal;
		document.getElementById('cartModalOverlay').onclick = closeCartModal;

		function loadProduct() {
			const id = getProductIdFromUrl();
			if (!id) return;
			fetch(`http://localhost:8001/api/product/${id}/`)
				.then(res => res.json())
				.then(product => {
					// !!! Вот тут определяем категорию !!!
					activeCategory = product.category || 'men'; // или women
					renderNavTop(); // теперь меню будет с нужной категорией
					renderSub(activeCategory);
					renderProduct(product);
				});
		}

		loadProduct();

		// Вставь после загрузки DOM
		function getUrlParam(name) {
			return new URLSearchParams(window.location.search).get(name);
		}
		const brandLogo = document.getElementById('brandLogo');
		if (getUrlParam('from') === 'kids') {
			brandLogo.innerHTML = '<img style="text-align: center; justify-content: center;" width="180px" src="https://tourmaline-twilight-0044d0.netlify.app/logo0b.png" alt="">';
		} else {
			brandLogo.innerHTML = '<img style="text-align: center; justify-content: center;" width="180px" src="https://tranquil-boba-b4a56b.netlify.app/logo%20birruti.png" alt="">';
		}

		function isKidsPage() {
			return getUrlParam('from') === 'kids';
		}
	</script>
</body>

</html>